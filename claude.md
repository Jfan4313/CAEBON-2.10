# Claude 辅助开发与架构规范 (AI Coding Guidelines)

本文档旨在为 AI (如 Claude, Gemini 等) 以及参与本项目的开发者提供关于代码架构、代码风格以及未来板块拆分的统一规范。在处理新的需求或重构现有代码时，请严格遵守以下原则。

## 1. 核心架构理念：按业务板块拆分 (Feature-Based / Domain-Driven)

随着本项目支持的零碳业务板块（如光伏、储能、空调、微电网等）不断增加，传统的“所有组件扁平放在 `components/` 目录下”的组织方式会导致严重的代码耦合和难以维护。

未来的代码拓展**必须**采用按业务板块拆分的设计模式。

### 推荐的目录结构

后续新增板块或对现有板块进行深度重构时，请按照以下结构组织代码：

```text
src/
├── modules/ (或者 components/modules/)  <-- 核心业务板块，每个业务板块为一个独立目录
│   ├── solar/ (光伏板块) [已完成模块化迁移]
│   │   ├── index.tsx         # 板块入口页面，负责组装内部组件
│   │   ├── components/       # 该板块专属的UI子组件 (SolarForm, SolarCharts)
│   │   ├── hooks.ts          # 核心业务逻辑、EPC/EMC 财务测算引擎
│   │   └── types.ts          # 财务模型与工程参数类型定义
│   ├── storage/ (储能板块) [待拆分]
│   ├── ev/ (充电桩板块) [待拆分]
│   └── ... 
├── shared/                   <-- 全局共享基建
│   ├── components/           # 跨板块通用的 UI 组件 (Button, Table, Card 等)
│   ├── hooks/                # 全局共用 Hook
│   ├── utils/                # 纯函数、格式化工具
│   └── types/                # 全局类型
├── context/                  <-- 状态管理 (已拆分为 App, Config, Module 等核心领域)
└── services/                 <-- 纯粹的外部服务封装 (API请求, 存储操作)
```

## 2. 状态管理规范

- **避免“上帝 Context”**：在近期的重构中，我们已经将大一统的 `ProjectContext` 拆分为职责明确的 `AppContext`、`ConfigContext` 和 `ModuleContext`。
- **状态下放**：如果一个状态仅在某一个板块（例如光伏）内部流转，**不要**将其放入全局 Context，而应通过板块自身的 local state (或 `hooks.ts`) 管理。
- **跨模块通信**：仅当数据需要在“项目总览”或“多个不同板块之间联动”时，才将其提升至 `ModuleContext` 或 `ConfigContext`。

## 3. 组件编写原则 (KISS 原则)

- **单一职责**：如果一个文件超过 500 行，意味着它可能需要被拆分；如果超过 1000 行，则**必须拆分**。
- **UI 与逻辑分离**：复杂的计算、数据转换和数据获取（API Call），应抽取到单独的 Hook 中（如 `useSolarRetrofit()`），让 TSX 视图文件自身只关注渲染逻辑。
- **解耦基础数据**：组件中不应硬编码大量业务默认值，应提取到 `initialData.ts` 或模块内部的 `types.ts`。

## 4. AI 编码指令 (给大模型的 Prompt 提示)

当 AI 参与本作的扩建时，请随时召回以下指令约束：
1. **优先检索板块结构**：在实现新功能前，先检查 `modules/` 下是否已有对应领域。
2. **渐进式重构**：如需修改类似 `RetrofitSolar.tsx` 这样的遗留巨型组件，第一步是“拆分子组件”，然后再添加新特性，而不是在一座“屎山”上继续堆砌。
3. **保持类型安全**：任何重组合并都应先定义或更新相关的 TypeScript 接口，消灭 `any`，并修复所有的类型报错。
4. **简洁至上**：坚决避免过度工程。在保证可维护性的前提下，只写能够解决当前需求的代码。

## 5. 最近更新记录 (Recent Milestones)

- **2026-02-27**: 完成分布式光伏模块的深度重构与功能增强。
  - 结构从 `components/RetrofitSolar.tsx` 迁移至 `modules/solar/`。
  - 逻辑层与视图层完全分离，计算引擎支持 EPC/EMC 模式。
  - 报告中心完成全中文化适配，支持 0.001 级高精度导出。

## 6. 未来演进与视角的 AI 辅助指引

在后续扩展新板块或深入现有板块时，你的代码修改和方案设计需要带入以下三个视角的立体思考：
1. **专家深度**：在涉及算法和业务逻辑实现时（例如 VPP、互补综合能源），确保有严谨的数据依据，而非简单加减乘除。优先引入业界标准与物理逻辑进行测算。
2. **业主精细度**：关注资金的时间价值与风险变量。实现财务模块时，务必考虑 O&M 全生命周期成本、设备真实衰减曲线以及敏感性分析能力，提供可信且保守的 IRR 与 Payback。
3. **销售表现力**：在设计 UI 和图表交互时，站在“非技术受众”的角度。通过可视化大屏、一页纸报告形式，将复杂逻辑包装为“易看懂”、“能成单”的极简精美输出。

---
